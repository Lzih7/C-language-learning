# 制作⼀个呼吸灯

• ⽬标：制作⼀个 LED 呼吸灯，并使⽤ 按键1 控制 LED 开关  
• 提⽰：利⽤ TIM 的 PWM 输出实现  

• 问题：  
    ◦ 配置 TIM 的⼤致流程是怎样的？  
    ◦ 此时控制 LED 的 GPIO 需要配置为什么模式？为什么？  
    ◦ 简要介绍 PWM 的输出构成以及如何计算相应参数  


---

要在 STM32 平台上制作一个 LED 呼吸灯，并通过按键控制其开关，利用定时器（TIM）实现 PWM 输出，以下是详细的实现思路，不需要具体的代码，但涵盖关键步骤：

## 1. **硬件连接**
   - **2个LED**：分别连接到 `PA0` 和 `PA1` 引脚。
   - **按键1**：连接到 `PB0` 引脚，用作控制 LED 呼吸灯的开关。
   - **呼吸灯效果**：利用定时器的 PWM 输出，控制 LED 的亮度从 0% 到 100% 再到 0%，形成渐亮渐暗的呼吸灯效果。

## 2. **总体思路**
   - 利用定时器的 PWM 功能控制 LED 亮度，通过调整 PWM 占空比来实现呼吸灯效果。
   - 通过外部中断检测按键的按下，实现呼吸灯的开关切换。
   - 系统上电时，两个 LED 默认进入呼吸模式，按下按键后关闭呼吸灯，再按一次按键恢复呼吸灯效果。

## 3. **步骤解析**

### 3.1 **GPIO 配置**
   - **PA0 和 PA1**：配置为定时器的 PWM 输出引脚，使用推挽复用输出模式（`GPIO_Mode_AF_PP`）。
   - **PB0**：配置为上拉输入模式（`GPIO_Mode_IPU`），并关联到 EXTI 外部中断线路，检测按键按下。

### 3.2 **定时器 (TIM) 配置**
   - 使用 **TIM2**（或其他定时器）来生成 PWM 信号。
   - TIM2 有多个输出通道，分别对应到 `PA0` 和 `PA1`。
   - **PWM 频率**：通常设置为 1kHz，以避免 LED 闪烁。
   - **PWM 周期**：通过改变 PWM 占空比（0% 到 100% 再到 0%），控制 LED 的亮度变化，形成呼吸灯效果。
     - 可以在定时器中通过调整 `TIM_SetCompare()` 函数来实时更新 PWM 占空比，实现 LED 的渐亮渐暗效果。
   - 使用两个独立的通道来分别控制 `PA0` 和 `PA1` 上的 LED。

### 3.3 **呼吸灯效果**
   - 通过一个定时循环函数，逐步增加和减少 PWM 占空比，从而实现 LED 的呼吸效果：
     - **增加占空比**：LED 逐渐变亮。
     - **减少占空比**：LED 逐渐变暗。
   - 每次更新占空比时，使用 `TIM_SetCompareX()` 来调整相应通道的 PWM 占空比。

### 3.4 **按键检测**
   - 使用 **EXTI（外部中断）** 来检测按键 `PB0` 的按下：
     - **下降沿触发中断**：按键按下时产生中断。
     - 在中断处理函数中，切换一个标志变量（`led_on`），用于控制 LED 呼吸灯的开关状态。
     - 按下按键时，如果呼吸灯正在运行，则关闭呼吸灯；如果呼吸灯已关闭，则重新启动呼吸灯。

### 3.5 **状态管理**
   - 通过全局变量 `led_on` 来记录当前 LED 的状态：
     - 初始状态：`led_on = 1`，表示 LED 呼吸灯开启。
     - 当检测到按键按下后，切换 `led_on` 的状态：
       - 如果 `led_on == 1`，则关闭 LED 呼吸效果（将 PWM 占空比设置为 0）。
       - 如果 `led_on == 0`，则重新启动呼吸灯效果。

### 3.6 **中断处理逻辑**
   - 在外部中断处理函数中，执行以下操作：
     1. 检查中断是否由 `PB0` 按键触发。
     2. 切换 LED 状态：
        - 如果当前 LED 处于呼吸模式，则停止呼吸灯效果。
        - 如果当前 LED 关闭，则重新启动呼吸灯效果。
     3. 清除中断标志位，准备下一次中断检测。

## 4. **延时与占空比调整**
   - 为了控制呼吸灯的速度，可以使用定时器或简单的延时循环控制呼吸周期。比如通过调整 `PWM` 的更新频率，使 LED 每秒完成一次完整的呼吸循环。

## 5. **主要模块总结**
   - **GPIO 配置**：PA0 和 PA1 作为 PWM 输出引脚，PB0 作为按键输入。
   - **TIM 定时器**：设置 PWM 频率为 1kHz，通过占空比调节 LED 亮度。
   - **EXTI 外部中断**：用于检测按键按下，切换 LED 呼吸灯的开关。
   - **PWM 占空比调整**：动态调节占空比以实现呼吸灯效果。
   - **按键状态切换**：每按一次按键，切换 LED 呼吸灯的开关状态。




---
# Q1:配置 TIM 的⼤致流程是怎样的?
在 STM32 中配置定时器（TIM）的基本流程一般分为以下几个步骤，下面以基本的定时器和 PWM 输出的配置为例：

### 1. **使能定时器时钟**
   在配置定时器之前，首先要使能与定时器相关的时钟。STM32 有多个定时器（TIM1、TIM2、TIM3 等），它们的时钟是独立的，需要通过 RCC 外设来使能。
   ```c
   RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);  // 启动 TIM2 的时钟
   ```

### 2. **配置定时器基础参数**
   定时器的基础参数包括自动重装载值（`Period`）、预分频器（`Prescaler`）、计数模式等。通过这些参数，你可以设置定时器的工作频率和计数模式。
   - **Period**：决定定时器的周期，当计数器到达该值时，定时器计数器会重置。
   - **Prescaler**：用于对输入时钟进行分频，从而调整定时器的计数频率。
   - **计数模式**：可以设置为向上、向下或中心对齐模式。

   代码示例：
   ```c
   TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
   TIM_TimeBaseStructure.TIM_Period = 999;  // 设置自动重装载值，控制周期
   TIM_TimeBaseStructure.TIM_Prescaler = 71;  // 设置预分频器，控制计数器时钟频率
   TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1;  // 时钟分频
   TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  // 向上计数模式
   TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);
   ```

### 3. **配置定时器的输出比较功能（PWM 或其他）**
   如果你使用定时器的 PWM 功能，接下来需要配置定时器的输出比较通道。输出比较通道决定了定时器的比较行为和占空比输出。

   - **OCMode**：设置 PWM 模式，比如 `TIM_OCMode_PWM1`。
   - **Pulse**：设置 PWM 的占空比，决定输出信号的高电平持续时间。
   - **OutputState**：启用或禁用输出。
   - **OCPolarity**：设置输出极性，决定是高电平有效还是低电平有效。

   代码示例：
   ```c
   TIM_OCInitTypeDef TIM_OCInitStructure;
   TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;  // PWM 模式 1
   TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;  // 启用输出
   TIM_OCInitStructure.TIM_Pulse = 500;  // 设置占空比
   TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;  // 高电平有效
   TIM_OC1Init(TIM2, &TIM_OCInitStructure);  // 初始化 TIM2 的通道 1
   ```

### 4. **启动定时器**
   在配置完定时器之后，需要启动定时器，让其开始计数或产生 PWM 信号。

   代码示例：
   ```c
   TIM_Cmd(TIM2, ENABLE);  // 启动定时器
   ```


### 总结：
配置 STM32 定时器的大致流程为：
1. 启用定时器时钟。
2. 配置定时器的基础参数（周期、预分频器、计数模式等）。
3. 配置输出比较功能（如 PWM 模式）。
4. 启动定时器。


根据不同的应用场景（如 PWM 输出、输入捕获、定时功能），定时器的配置可能有所不同。

# Q2: 控制 LED 的 GPIO 需要配置为什么模式？为什么？
`GPIO_Mode_AF_PP` 是 STM32 标准外设库中的一个常量，用于配置 GPIO 引脚的模式。它表示**复用推挽输出模式**（Alternate Function Push-Pull）。

### 详细解释：
1. **AF（Alternate Function）**：代表**复用功能**。STM32 的 GPIO 引脚可以复用为不同的外设功能。例如一个引脚既可以作为普通的 GPIO，也可以用来作为定时器输出、UART 通信等。当你将引脚配置为 `AF` 模式时，它将不再是普通的 GPIO 输入/输出，而是复用为与外设相关的功能。

2. **PP（Push-Pull）**：代表**推挽输出**。在推挽模式下，GPIO 引脚可以输出高电平（连接到 VDD）或低电平（连接到 GND），这是常用的输出模式，可以驱动负载（如 LED、外设等）。

### 应用场景：
- 当 GPIO 引脚被配置为用于 **PWM 输出** 时（例如控制 LED 亮度），需要设置为 `GPIO_Mode_AF_PP`，使其复用为定时器通道的输出引脚。


# Q3:PWM 的输出构成
### PWM 的输出构成

**PWM（脉宽调制，Pulse Width Modulation）** 是通过调节信号的**占空比**（Duty Cycle），来控制输出信号的平均功率或电压。PWM 信号通常为方波，且保持恒定频率，但通过改变每个周期中高电平持续的时间，来控制输出信号的能量传递。

#### 主要构成：
1. **周期（Period）**：
   - PWM 信号的总周期，也就是信号从开始到重复一次所花费的时间，通常以频率表示（周期的倒数）。
   - 周期 = $$ \frac{1}{PWM\ 频率} $$。
   
2. **占空比（Duty Cycle）**：
   - 占空比是高电平时间相对于整个周期的比率，决定了输出的平均电压。占空比越大，平均电压越高。
   - 占空比 = $$ \frac{高电平时间}{周期} \times 100\% $$。

3. **高电平时间（Pulse Width）**：
   - PWM 信号在一个周期内的高电平持续时间，用于控制负载的驱动时间。

### 如何计算 PWM 的参数

#### 1. **周期与频率计算**：
- 假设定时器输入时钟频率为 $$ f_{clk} $$，定时器的预分频器设置为 `Prescaler`，周期计数器（自动重装载寄存器）设置为 `Period`，则 PWM 信号的频率可以表示为：
  $$
  PWM\ 频率 = \frac{f_{clk}}{(Prescaler + 1) \times (Period + 1)}
  $$
  其中：
  - `f_{clk}` 是定时器的输入时钟频率。
  - `Prescaler` 是定时器的预分频器值。
  - `Period` 是定时器的自动重装载寄存器的值（用于定义周期的长度）。

#### 2. **占空比的计算**：
- 占空比由定时器的输出比较寄存器（`CCR`）决定。`CCR` 的值控制高电平的时间长度。占空比的公式为：
  $$
  占空比 = \frac{CCR}{Period} \times 100\%
  $$
  其中：
  - `CCR` 是定时器输出比较寄存器的值。
  - `Period` 是定时器的自动重装载值。

#### 3. **实际应用中的参数选择**：
- **频率选择**：取决于应用场景。比如在 LED 调光中，PWM 频率通常在几百 Hz 到几 kHz 之间，以避免可见闪烁。在电机控制中，PWM 频率通常在 kHz 级别。
- **占空比调整**：占空比直接影响驱动器件的输出功率。通过动态调节占空比，可以实现亮度控制、速度控制等。

### 例子：
- **假设**定时器输入时钟为 72MHz，预分频器设为 71，自动重装载值设为 999，则 PWM 频率为：
  $$
  PWM\ 频率 = \frac{72 \times 10^6}{(71 + 1) \times (999 + 1)} = 1 kHz
  $$
- 如果输出比较寄存器 `CCR` 的值为 500，那么占空比为：
  $$
  占空比 = \frac{500}{999} \times 100\% = 50\%
  $$

### 总结：
PWM 的输出是由周期、占空比和高电平时间组成的，频率和占空比的选择取决于应用的需求。通过设置定时器的 `Prescaler` 和 `Period` 来控制 PWM 的频率，通过 `CCR` 来控制占空比。